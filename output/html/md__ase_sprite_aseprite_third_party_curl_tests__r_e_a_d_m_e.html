<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: The curl Test Suite</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project<span id="projectnumber">&#160;Version 0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">The curl <a class="el" href="class_test.html">Test</a> Suite </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1340"></a>
Running</h1>
<h2><a class="anchor" id="autotoc_md1341"></a>
Requires to run</h2>
<ul>
<li>perl (and a unix-style shell)</li>
<li>python (and a unix-style shell, for SMB and <a class="el" href="struct_t_e_l_n_e_t.html">TELNET</a> tests)</li>
<li>python-impacket (for SMB tests)</li>
<li>diff (when a test fails, a diff is shown)</li>
<li>stunnel (for HTTPS and FTPS tests)</li>
<li>OpenSSH or SunSSH (for SCP, SFTP and SOCKS4/5 tests)</li>
<li>nghttpx (for HTTP/2 tests)</li>
<li>nroff (for &ndash;manual tests)</li>
<li>An available <code>en_US.UTF-8</code> locale</li>
</ul>
<h3><a class="anchor" id="autotoc_md1342"></a>
Installation of python-impacket</h3>
<p>The Python-based test servers support both recent Python 2 and 3. You can figure out your default Python interpreter with python -V</p>
<p>Please install python-impacket in the correct Python environment. You can use pip or your OS' package manager to install 'impacket'.</p>
<p>On Debian/Ubuntu the package names are:</p>
<ul>
<li>Python 2: 'python-impacket'</li>
<li>Python 3: 'python3-impacket'</li>
</ul>
<p>On FreeBSD the package names are:</p>
<ul>
<li>Python 2: 'py27-impacket'</li>
<li>Python 3: 'py37-impacket'</li>
</ul>
<p>On any system where pip is available:</p>
<ul>
<li>Python 2: 'pip2 install impacket'</li>
<li>Python 3: 'pip3 install impacket'</li>
</ul>
<p>You may also need to manually install the Python package 'six' as that may be a missing requirement for impacket on Python 3.</p>
<h3><a class="anchor" id="autotoc_md1343"></a>
Port numbers used by test servers</h3>
<p>All test servers run on "random" port numbers. All tests should be written to use suitable variables instead of fixed port numbers so that test cases continue to work independent on what port numbers the test servers actually use.</p>
<p>See <a class="el" href="md__ase_sprite_aseprite_third_party_curl_tests__f_i_l_e_f_o_r_m_a_t.html">FILEFORMAT</a> for the port number variables.</p>
<h3><a class="anchor" id="autotoc_md1344"></a>
Test servers</h3>
<p>The test suite runs stand-alone servers on random ports to which it makes requests. For SSL tests, it runs stunnel to handle encryption to the regular servers. For SSH, it runs a standard OpenSSH server. For SOCKS4/5 tests SSH is used to perform the SOCKS functionality and requires a SSH client and server.</p>
<p>The listen port numbers for the test servers are picked randomly to allow users to run multiple test cases concurrently and to not collide with other existing services that might listen to ports on the machine.</p>
<p>The <a class="el" href="struct_h_t_t_p.html">HTTP</a> server supports listening on a Unix domain socket, the default location is 'http.sock'.</p>
<h3><a class="anchor" id="autotoc_md1345"></a>
Run</h3>
<p><code>./configure &amp;&amp; make &amp;&amp; make test</code>. This builds the test suite support code and invokes the 'runtests.pl' perl script to run all the tests. Edit the top variables of that script in case you have some specific needs, or run the script manually (after the support code has been built).</p>
<p>The script breaks on the first test that doesn't do OK. Use <code>-a</code> to prevent the script from aborting on the first error. Run the script with <code>-v</code> for more verbose output. Use <code>-d</code> to run the test servers with debug output enabled as well. Specifying <code>-k</code> keeps all the log files generated by the test intact.</p>
<p>Use <code>-s</code> for shorter output, or pass test numbers to run specific tests only (like <code>./runtests.pl 3 4</code> to test 3 and 4 only). It also supports test case ranges with 'to', as in <code>./runtests.pl 3 to 9</code> which runs the seven tests from 3 to 9. Any test numbers starting with ! are disabled, as are any test numbers found in the files <code>data/DISABLED</code> or <code>data/DISABLED.local</code> (one per line). The latter is meant for local temporary disables and will be ignored by git.</p>
<p><a class="el" href="class_test.html">Test</a> cases mentioned in <code>DISABLED</code> can still be run if <code>-f</code> is provided.</p>
<p>When <code>-s</code> is not present, each successful test will display on one line the test number and description and on the next line a set of flags, the test result, current test sequence, total number of tests to be run and an estimated amount of time to complete the test run. The flags consist of these letters describing what is checked in this test:</p>
<p>s stdout d data u upload p protocol o output e exit code m memory v valgrind</p>
<h3><a class="anchor" id="autotoc_md1346"></a>
Shell startup scripts</h3>
<p>Tests which use the ssh test server, SCP/SFTP/SOCKS tests, might be badly influenced by the output of system wide or user specific shell startup scripts, .bashrc, .profile, /etc/csh.cshrc, .login, /etc/bashrc, etc. which output text messages or escape sequences on user login. When these shell startup messages or escape sequences are output they might corrupt the expected stream of data which flows to the sftp-server or from the ssh client which can result in bad test behavior or even prevent the test server from running.</p>
<p>If the test suite ssh or sftp server fails to start up and logs the message 'Received message too long' then you are certainly suffering the unwanted output of a shell startup script. Locate, cleanup or adjust the shell script.</p>
<h3><a class="anchor" id="autotoc_md1347"></a>
Memory test</h3>
<p>The test script will check that all allocated memory is freed properly IF curl has been built with the <code>CURLDEBUG</code> define set. The script will automatically detect if that is the case, and it will use the 'memanalyze.pl' script to analyze the memory debugging output.</p>
<p>Also, if you run tests on a machine where valgrind is found, the script will use valgrind to run the test with (unless you use <code>-n</code>) to further verify correctness.</p>
<p>runtests.pl's <code>-t</code> option will enable torture testing mode, which runs each test many times and makes each different memory allocation fail on each successive run. This tests the out of memory error handling code to ensure that memory leaks do not occur even in those situations. It can help to compile curl with <code>CPPFLAGS=-DMEMDEBUG_LOG_SYNC</code> when using this option, to ensure that the memory log file is properly written even if curl crashes.</p>
<h3><a class="anchor" id="autotoc_md1348"></a>
Debug</h3>
<p>If a test case fails, you can conveniently get the script to invoke the debugger (gdb) for you with the server running and the exact same command line parameters that failed. Just invoke <code>runtests.pl &lt;test number&gt; -g</code> and then just type 'run' in the debugger to perform the command through the debugger.</p>
<h3><a class="anchor" id="autotoc_md1349"></a>
Logs</h3>
<p>All logs are generated in the log/ subdirectory (it is emptied first in the runtests.pl script). They remain in there after a test run.</p>
<h3><a class="anchor" id="autotoc_md1350"></a>
Test input files</h3>
<p>All test cases are put in the <code>data/</code> subdirectory. Each test is stored in the file named according to the test number.</p>
<p>See <a class="el" href="md__ase_sprite_aseprite_third_party_curl_tests__f_i_l_e_f_o_r_m_a_t.html">FILEFORMAT.md</a> for a description of the test case file format.</p>
<h3><a class="anchor" id="autotoc_md1351"></a>
Code coverage</h3>
<p>gcc provides a tool that can determine the code coverage figures for the test suite. To use it, configure curl with &lsquo;CFLAGS=&rsquo;-fprofile-arcs -ftest-coverage -g -O0'`. Make sure you run the normal and torture tests to get more full coverage, i.e. do:</p>
<p>make test make test-torture</p>
<p>The graphical tool ggcov can be used to browse the source and create coverage reports on *NIX hosts:</p>
<p>ggcov -r lib src</p>
<p>The text mode tool gcov may also be used, but it doesn't handle object files in more than one directory very well.</p>
<h3><a class="anchor" id="autotoc_md1352"></a>
Remote testing</h3>
<p>The runtests.pl script provides some hooks to allow curl to be tested on a machine where perl can not be run. The test framework in this case runs on a workstation where perl is available, while curl itself is run on a remote system using ssh or some other remote execution method. See the comments at the beginning of runtests.pl for details.</p>
<h2><a class="anchor" id="autotoc_md1353"></a>
Test case numbering</h2>
<p><a class="el" href="class_test.html">Test</a> cases used to be numbered by category ranges, but the ranges filled up. Subsets of tests can now be selected by passing keywords to the runtests.pl script via the make <code>TFLAGS</code> variable.</p>
<p>New tests are added by finding a free number in <code>tests/data/Makefile.inc</code>.</p>
<h2><a class="anchor" id="autotoc_md1354"></a>
Write tests</h2>
<p>Here's a quick description on writing test cases. We basically have three kinds of tests: the ones that test the curl tool, the ones that build small applications and test libcurl directly and the unit tests that test individual (possibly internal) functions.</p>
<h3><a class="anchor" id="autotoc_md1355"></a>
test data</h3>
<p>Each test has a master file that controls all the test data. What to read, what the protocol exchange should look like, what exit code to expect and what command line arguments to use etc.</p>
<p>These files are <code>tests/data/test[num]</code> where <code>[num]</code> is just a unique identifier described above, and the XML-like file format of them is described in the separate <a class="el" href="md__ase_sprite_aseprite_third_party_curl_tests__f_i_l_e_f_o_r_m_a_t.html">FILEFORMAT.md</a> document.</p>
<h3><a class="anchor" id="autotoc_md1356"></a>
curl tests</h3>
<p><a class="el" href="class_a.html">A</a> test case that runs the curl tool and verifies that it gets the correct data, it sends the correct data, it uses the correct protocol primitives etc.</p>
<h3><a class="anchor" id="autotoc_md1357"></a>
libcurl tests</h3>
<p>The libcurl tests are identical to the curl ones, except that they use a specific and dedicated custom-built program to run instead of "curl". This tool is built from source code placed in <code>tests/libtest</code> and if you want to make a new libcurl test that is where you add your code.</p>
<h3><a class="anchor" id="autotoc_md1358"></a>
unit tests</h3>
<p>Unit tests are placed in <code>tests/unit</code>. There's a tests/unit/README describing the specific set of checks and macros that may be used when writing tests that verify behaviors of specific individual functions.</p>
<p>The unit tests depend on curl being built with debug enabled. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
